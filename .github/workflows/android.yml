name: Build Android App

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable' # Use latest stable version for best compatibility
          
      - name: Create Flutter Project Structure
        run: |
          # Clean start
          rm -rf android

          # Enable Android
          flutter config --enable-android

          # Generate in temp folder
          flutter create temp_runner --org com.speedguard.app --project-name speedguard --template=app --platforms android

          # Copy android folder to root
          cp -r temp_runner/android .

          # Cleanup
          rm -rf temp_runner

          # Debug: List directory structure
          echo "=== Android directory structure ==="
          find android -type f -name "*.gradle*" -o -name "*.properties" -o -name "*.xml" | sort

      - name: Fix Gradle Build Configuration
        run: |
          # -------------------------------------------------------
          # Fix the "afterEvaluate" error by writing clean build files
          # that are compatible with the new declarative plugin system.
          # -------------------------------------------------------

          # 1) Fix settings.gradle - pin compatible AGP + Kotlin versions
          SETTINGS_FILE=$(find android -maxdepth 1 -name "settings.gradle.kts" -o -name "settings.gradle" | head -n 1)
          echo "Found settings file: $SETTINGS_FILE"

          if [ -n "$SETTINGS_FILE" ]; then
            # Pin AGP to 8.1.0 (compatible with Gradle 8.x bundled by Flutter)
            sed -i 's/id "com.android.application" version "[^"]*"/id "com.android.application" version "8.1.0"/' "$SETTINGS_FILE"
            sed -i "s/id 'com.android.application' version '[^']*'/id 'com.android.application' version '8.1.0'/" "$SETTINGS_FILE"
            # Pin Kotlin to 1.9.23
            sed -i 's/id "org.jetbrains.kotlin.android" version "[^"]*"/id "org.jetbrains.kotlin.android" version "1.9.23"/' "$SETTINGS_FILE"
            sed -i "s/id 'org.jetbrains.kotlin.android' version '[^']*'/id 'org.jetbrains.kotlin.android' version '1.9.23'/" "$SETTINGS_FILE"
            echo "=== Patched settings.gradle ==="
            cat "$SETTINGS_FILE"
          fi

          # 2) Write a clean root build.gradle that avoids afterEvaluate issues
          ROOT_BUILD=$(find android -maxdepth 1 -name "build.gradle.kts" -o -name "build.gradle" | head -n 1)
          echo "Found root build file: $ROOT_BUILD"

          if [[ "$ROOT_BUILD" == *".kts" ]]; then
            cat > "$ROOT_BUILD" << 'ROOTKTS'
          allprojects {
              repositories {
                  google()
                  mavenCentral()
              }
          }

          val newBuildDir: Directory = rootProject.layout.buildDirectory.get().dir("../../build")
          rootProject.layout.buildDirectory.value(newBuildDir)

          subprojects {
              val newSubprojectBuildDir: Directory = newBuildDir.dir(project.name)
              project.layout.buildDirectory.value(newSubprojectBuildDir)
          }

          tasks.register<Delete>("clean") {
              delete(rootProject.layout.buildDirectory)
          }
          ROOTKTS
          else
            cat > "$ROOT_BUILD" << 'ROOTGROOVY'
          allprojects {
              repositories {
                  google()
                  mavenCentral()
              }
          }

          rootProject.buildDir = "../build"

          subprojects {
              project.buildDir = "${rootProject.buildDir}/${project.name}"
          }

          tasks.register("clean", Delete) {
              delete rootProject.buildDir
          }
          ROOTGROOVY
          fi
          echo "=== Clean root build.gradle ==="
          cat "$ROOT_BUILD"

          # 3) Ensure app/build.gradle has correct minSdk for plugins
          APP_BUILD=$(find android/app -name "build.gradle.kts" -o -name "build.gradle" | head -n 1)
          echo "Found app build file: $APP_BUILD"

          if [ -n "$APP_BUILD" ]; then
            # Set minSdk to 21 (required by geolocator, permission_handler etc.)
            sed -i 's/minSdk\s*=\s*flutter.minSdkVersion/minSdk = 21/' "$APP_BUILD"
            sed -i 's/minSdkVersion\s*flutter.minSdkVersion/minSdkVersion 21/' "$APP_BUILD"
            sed -i 's/minSdk\s*=\s*[0-9]*/minSdk = 21/' "$APP_BUILD"
            echo "=== Patched app/build.gradle ==="
            cat "$APP_BUILD"
          fi

          # 4) Add helpful gradle.properties
          GRADLE_PROPS="android/gradle.properties"
          if [ -f "$GRADLE_PROPS" ]; then
            # Ensure AndroidX and proper JVM args
            grep -q "android.useAndroidX" "$GRADLE_PROPS" || echo "android.useAndroidX=true" >> "$GRADLE_PROPS"
            grep -q "org.gradle.jvmargs" "$GRADLE_PROPS" || echo "org.gradle.jvmargs=-Xmx4G -XX:+HeapDumpOnOutOfMemoryError" >> "$GRADLE_PROPS"
            echo "=== gradle.properties ==="
            cat "$GRADLE_PROPS"
          fi

      - name: Configure Android Permissions
        run: |
          # Inject permissions into AndroidManifest.xml
          MANIFEST=$(find android -name AndroidManifest.xml -path "*/main/*" | head -n 1)
          if [ -z "$MANIFEST" ]; then
            MANIFEST=$(find android -name AndroidManifest.xml | head -n 1)
          fi
          if [ -z "$MANIFEST" ]; then
            echo "ERROR: AndroidManifest.xml not found!"
            exit 1
          fi
          echo "Injecting permissions into $MANIFEST"
          PERMISSIONS='<uses-permission android:name="android.permission.INTERNET"/>\n    <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/>\n    <uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION"/>\n    <uses-permission android:name="android.permission.WAKE_LOCK"/>'
          sed -i "s|<application|${PERMISSIONS}\n    <application|g" "$MANIFEST"
          echo "=== AndroidManifest.xml ==="
          cat "$MANIFEST"


      - name: Install Dependencies
        run: flutter pub get

      - name: Build APK (Release mode)
        run: flutter build apk --release

      - name: Rename APK
        run: mv build/app/outputs/flutter-apk/app-release.apk app-release.apk

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release
          path: app-release.apk

      - name: Create Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: Release v1.0.${{ github.run_number }}
          files: app-release.apk
          draft: false
          prerelease: false
